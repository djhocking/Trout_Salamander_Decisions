---
output: html_document
---

## Salamander Occupancy - Expert Elicitation Manuscript
RMarkdown File

Created by: Rachel Katz (rachelakatz@gmail.com)
Co-authors: Dan Hocking, Evan Grant

Created: Feb 01 2016

Last Updated: Feb 05 2016

```{r import data, echo=FALSE, results='hide'}
# install libraries
library(knitr)
library(xtable)
library(dplyr)
db <- src_postgres(dbname='conte_dev', host='127.0.0.1', port='5432', user='conte', password='conte')
print(db)

drv <- dbDriver("PostgreSQL")
con <- dbConnect(drv, dbname='sheds', host='osensei.cns.umass.edu', user=options('SHEDS_USERNAME'), password=options('SHEDS_PASSWORD'))

#import data
upstream.areasqkm.data<-read.csv("/Users/katz-umass/Dropbox/Headwater Stream SDM/gis/data files/fromkyle/covariates/upstream_AreaSqKM.csv",fill=TRUE,header=TRUE)
upstream.forest.mean.data<-read.csv("/Users/katz-umass/Dropbox/Headwater Stream SDM/gis/data files/fromkyle/covariates/upstream_forest_MEAN.csv",fill=TRUE,header=TRUE)

#import list of experts
expert.list.data<-read.csv("/Users/katz-umass/github_folder/Trout_Salamander_Decisions/Data/salamander_experts_list.csv",fill=TRUE,header=TRUE)

# combine all catchment data into a single object
catchment.data<-cbind(upstream.areasqkm.data,upstream.forest.mean.data)

# subset to only include drainage areas less than 200km2 and greater than 0.75km2 and over 50% of area with forest cover data available 
catchment.data.sub1<-subset(catchment.data,catchment.data$AreaSqKM<200 & catchment.data$AreaSqKM>0.75 & catchment.data$percentAreaWithData>50)
length(catchment.data.sub1[,1])

```

### Outline

Overview: Elicite parameter values and model beliefs from experts for predicting effects of climate, land use, and brook-trout presense on catchment-level occupancy of three stream-salamander species occuring throughout the northeastern US. Use this model to forecast current distributions of salamanders under differnce climate scenarios and compare to exisiting published distributions/forecasts (?).

* Step 1: build the catchment-level salamander occupancy model
* Step 2: create expert elicitation survey for model parmaeters and beliefs (means only, use 20+ experts to get variance in mean expected values instead of eliciting confidence) 
* Step 3: identify salamander experts based on snow-ball or publication criteria
* Step 4: provide a list of literature for experts to consult prior to elicitation
* Step 5: compare expert opinions and host webinar/call if large discrepancys suggesting lack of understanding of the questions (repeat elicitation if needed)
* Step 6: forecast salamander occupancy based on expert elicitation
* Step 7: conduct sensititivly analysis for major uncertainties (hold all constant at the mean and vary one parmaeter at a time)

Potential Journals:

* Conservation Biology (see Martin et al. 2012, Addison et al. 2015)
* Other?

### Introduction

*Why use expert knowledge for prediction in conservation*

* Expert knowledge is widely used in conservation because of the complexity of ecological problems, relative lack of empirical data, and imminent nature of decisions. Must act in the face of limited data. 
* Thus, knowledge typically takes the form of mental models without explicit consideration of biases (i.e., experts are called on to express opinions in a qualitative and non-transparent way). 
* In fields where there is extensive expert knowledge, yet little published data, the use of expert information for ecological models is a cost-effective way of making more confident predictions about the effect of management.

*Increasing use of expert-knowledge in conservation*

* Increasing use of expert elicitation methods to help inform conservation decisions (identify important hypothesis and parameter uncertainties to resolve through research or monitoring).
* When empirical measures are required for evaluating alternative actions, but are not available, expert judgment can help develop plausible estimates that most effectively inform decisions (Speirs-Bridge et al. 2010; Martin et al. 2012). Expert opinions are valuable in the management of threatened species, where the need to make urgent decisions leaves little time for the collection of further information (?).
* Expert elicitation can be conducted within a probabilistic framework, which accounts for uncertainty (confidence) of multiple experts. Also used to parameterize models in the absence of data and as Bayesian priors to supplement sparse data and improve confidence in predictions (Yamada et al., 2003; Martin et al., 2005; Denham and Mengersen, 2007; Griffiths et al., 2007; Mac Nally, 2007; O’Neill et al., 2008; Low Choy et al., 2009; O’Leary et al., 2009; Murray et al., 2009; James et al., 2010)
* Some chance that expert opinions alone (w/ no data) may not be as useful? Yet, when lacking data, expert opinion does not necessarily offer an improvement (Cox, 2000; Pearce et al., 2001; Seoane et al., 2005).
* Examples of expert elicitation used to parameterize models that inform management decisions (from Martin et al. 2012 and Charney 2012:):

1. Johnson et al. 2010 – use to parameterize Bayesian network to evaluate population viability of cheetahs (X experts).
2. Runge et al. 2011 – use to identify alternative hypotheses and uncertainties affecting mgt of whooping cranes (X experts).
3. O’Neill et al. 2008 – used to quantify trends and range of effects of climate change on polar bears (10 experts).
4. Martin et al. 2005  and Kuhnert et al. 2005 – used to evaluate effects of livestock grazing intensity on austrialian woodland birds in Bayesian GLM (20 experts) 
5. Smith et al. 2011 – Bayesian networks

*What do we mean by "expert" - who are the experts?*

* An expert is someone who has substantial information on a particular topic that is not widely known by others and who is offered deferred to for their knowledge and interpretation.

*Expert elicitation process*

* Expert-elicitation (in general) is composed of 5 steps:
1. Deciding how information will be used (purpose and motivation)
2. Determining what to elicit (and identifying experts; creating a statistical model)
3. Designing elicitation process
4. Performing elicitation
5. Translating elicited information into quantitative statements that be used in ecological models (to ultimately help make decisions).

* Additional important steps to consider:
1. How to work with multiple experts
2. How to combine multiple judgments (treat as equal or weights, average or ranges)
3. Minimizing bias in elicited information
4. Verifying accuracy of expert information

*Why conduct expert elictation for predicting/forecasting stream salamander occupancy?*

* Limited information about amphibians (salamanders) region-wide and evidence that they are currently in decline (cite) and are threatened by climate change (cite).

* Three common stream salamdner species occur across the northeastern streams (i.e., relevant for NECSC) and are known to co-occur in streams with fishes (brook trout; cite), an important predictor/competitor affecting salamander populations, and are sensitive to buffer and upland forest cover, stream temperature and discharge (and network structure).

* Conduct expert elicitation for Plethedontide: Desmognathus fuscus; dusky salamander, Gyrinophilus porphyriticus; spring salamander, and Eurycea bislineata; two-lined salamander
* Local threats - land use (forest cover), fish-interactions, climate change (temperature and flow)
* Outstanding hypotheses relevant to conservation and management (personal communication; decision-model in prep): 

1. riparian vs. upland land protection is better for instream biota (downstream). Evidence that upland land protection can influence downstream habitat and species occurrence, yet conservation efforts are largely focused on riparian mgt first, then upland (we'll explore this in decision paper)
2. fish-interaction is strong or weak (brook trout-salamander interactions)
3. species-specific responses (how much do species vary?)
4. stream-network impacts on species-responses? some watersheds are more vulnerable than others (i.e., network structure, buffer vs. upland effects?)

* Call for experts to aid in identifying parameters to be used in both predictive and decision models to evaluate range of outcomes of conservation actions.
* Do predictions from experts vary from publications? (maybe compare in analysis or compare in discussion)
* Species distribution models have to make lots of assumptions, we hope experts are considering these assumption and relaxing them, thus providing a more realistic understanding of drivers of occurrence. (be specific here if we mention why SDM models aren't good enough - for using in next co-occuring paper and decision paper)

*Objectives of this paper*

Overall Motivation: Elicit parameters that can be used for 1) predicting/forecasting salamander occpuancy under climate change, 2) co-occurance (BT + SAL) models under climate change (Hocking et al. forecasting paper), and 3) evaluate robust land-protection strategies for salamanders and trout across watersheds in NE (Katz et al. optimization paper).

Questions:

1. How much do expert opinions agree? Where is the disagreement?
2. Which uncertainties drive forecasts of salamander occurrence (sensitivity analysis; tornado diagram)?
3. Does expert knowledge agree with with field-observations? (why or why not? do we have any? – see publication list that we’ll be sending to experts for potential comparisons).

### Methods

#### Salamander Occupancy Model

*Summary of predictor variables across NE catchments*

```{r predictor ranges, echo=FALSE}
# number of huc 10 watersheds for forecasting (all within NECSC region?)
no.huc10<-100

# range in catchment drainage area for elicitation
par(mfrow=c(2,2))
hist(catchment.data.sub1$AreaSqKM, main="drainage area", breaks=500);abline(v=mean(catchment.data.sub1$AreaSqKM),col="blue");abline(v=median(catchment.data.sub1$AreaSqKM),col="red")
hist(catchment.data.sub1$AreaSqKM, main="drainage area", breaks=500,xlim=c(0,20));abline(v=mean(catchment.data.sub1$AreaSqKM),col="blue");abline(v=median(catchment.data.sub1$AreaSqKM),col="red")
hist(catchment.data.sub1$MEAN, main="percent forest cover", breaks=500);abline(v=mean(catchment.data.sub1$MEAN),col="blue");abline(v=median(catchment.data.sub1$MEAN),col="red")

# lm.1<-lm(catchment.data.sub1$MEAN~catchment.data.sub1$AreaSqKM)
```

Range in predictor variable values, every 10% quantile (across `r length(catchment.data.sub1[,1])` catchments)

```{r table1, echo=FALSE, results="asis"}
# elicitation list of ranges
e.list<-matrix(nrow=10,ncol=11,rep(NA,2*11))
e.list[1,1:11]<-c(quantile(catchment.data.sub1$AreaSqKM,seq(0,1,.10)))
e.list[2,1:11]<-c(quantile(catchment.data.sub1$MEAN,seq(0,1,.10)))
e.list[3:10,1:11]<-c(rep(NA,11))
#e.list
colnames(e.list)<-c(seq(0,100, by=10))
rownames(e.list)<-c(
  "drainage_area_sqkm",
  "upstream_%forest",
  "non-buffer_%forest",
  "buffer30m_%forest",
  "upstream_non-riparian_%forest",
  "upstream_riparian30m_%forest",
  "stream_temp_julymean",
  "stream_temp_annualmax",
  "stream_flow_annualmin",
  "stream_flow_annualmax")
table1<-xtable(e.list)
print(table1, type="html")
```

*Occupancy model*

Response variable: probability of species-specific occupancy at the catchment-level

Catchment: Deliniated from hyresolution flow-lines (cite, Kyle). 

pr.occupancy[species,catchment]<-
intercept (overall average) + 
regional.effect (provinces) + drainage.area (stream size) + 
stream.temp (july mean or annual max) + 
stream.flow (precip x drainage area; high or low-flow magnitude) + 
riparian.forest (within 30m of riparian) + 
upland.forest (outside of 30m riparian) + 
riparian.forest x upland.forest (interaction term) + 
fish.presence (brook trout; yes or no) + 
residual variance

```{r occ.model.sim1, echo=FALSE, results='hide'}
no.catchments=100
no.species=1
no.simulations=20 # number of experts

# create empty vectors and matrices for storing output
sim1.data<-catchment.data.sub1[1:no.catchments,]
pr.occupancy<-alpha<-matrix(rep(NA,no.catchments*no.species*no.simulations))
dim(alpha)<-dim(pr.occupancy)<-c(no.catchments,no.species,no.simulations)
mean.pr.occupancy<-sd.pr.occupancy<-matrix(rep(NA,no.catchments*no.species),nrow=no.catchments,ncol=no.species)
intercept<-b1<-b2<-rep(NA,no.simulations)

# create parameter uncertainty 
# need to calcuate odd-ratios from expert elicitation
# unsure how to add variance/sd in odd-ratios
intercept[1:no.simulations]<-rnorm(no.simulations,mean=log(0.5/(1-0.5)),sd=0.1) # 0.5 average occupancy
b1[1:no.simulations]<-rnorm(no.simulations,log(10),sd=0.1) # 5x more likely to occur for every 1 percent increase in forest cover
b2[1:no.simulations]<-rnorm(no.simulations,log(0.90),sd=0.1) # 10x less likely to occur for every 1 sqkm increase in drainage area


for (species in 1:no.species){
  for (catchment in 1:no.catchments){
    for (sim in 1:no.simulations){
      alpha[catchment,species,sim]<-
      intercept[sim] + b1[sim]*sim1.data$MEAN[catchment] + b2[sim]*sim1.data$AreaSqKM[catchment]
      #+ regional.effect (provinces) 
      #+ stream.temp (july mean or annual max) 
      #+ stream.flow (precip x drainage area; high or low-flow magnitude) 
      #+ riparian.forest (within 30m of riparian)  
      #+ upland.forest (outside of 30m riparian) 
      #+ riparian.forest x upland.forest (interaction term) 
      #+ fish.presence (brook trout; yes or no) 
      #+ residual variance
    pr.occupancy[catchment,species,sim]<-exp(alpha[catchment,species,sim])/(exp(alpha[catchment,species,sim])+1) 
  } # sim
    mean.pr.occupancy[catchment,species]<-mean(pr.occupancy[catchment,species,1:no.simulations])
    sd.pr.occupancy[catchment,species]<-sd(pr.occupancy[catchment,species,1:no.simulations])
 }
}

head(alpha)
head(pr.occupancy)
```

Simulated parameter uncertainty across experts (N=`r no.simulations`, median = red)

```{r plot.parm.uncertainty,echo=FALSE, fig.width=6,fig.height=8}
par(mfrow=c(3,2))
hist(exp(intercept)/(exp(intercept)+1),main="average occupancy",breaks=10);abline(v=median(exp(intercept)/(exp(intercept)+1)),col="red");
plot(density(exp(intercept)/(exp(intercept)+1)),main="average occupancy");abline(v=median(exp(intercept)/(exp(intercept)+1)),col="red")

hist(exp(b1), main="odds ratio per 1 percent increase in upstream forest",breaks=10);abline(v=median(exp(b1)),col="red")
plot(density(exp(b1)), main="odds ratio per 1 percent increase in upstream forest");abline(v=median(exp(b1)),col="red")

hist(exp(b2), main="odds ratio per 1 sqkm increase in drainage area",breaks=10);abline(v=median(exp(b2)),col="red")
plot(density(exp(b2)), main="odds ratio per 1 sqkm increase in drainage area");abline(v=median(exp(b2)),col="red")
```

Predicted mean and sd in occupancy 

```{r plot.occ,echo=FALSE, fig.width=6,fig.height=8}
par(mfrow=c(2,2))
#plot(sim1.data$MEAN,sim1.data$AreaSqKM,xlab="percent upstream forest",ylab="drainage area")
plot(mean.pr.occupancy~sim1.data$MEAN,ylim=c(0,1),xlab="percent upstream forest")
plot(mean.pr.occupancy~sim1.data$AreaSqKM,ylim=c(0,1),xlab="drainage area")
plot(sd.pr.occupancy~sim1.data$MEAN,ylim=c(-2,2),xlab="percent upstream forest")
plot(sd.pr.occupancy~sim1.data$AreaSqKM,ylim=c(-2,2),xlab="drainage area")
```

Loop over alterantive climate, buffer, and fish models

*Climate model uncertainty*

*Buffer-Upland model uncertainty*

*Fish-Sal model uncertainty*

#### Elicitation Survey

Martin et al. 2005 (Eco Apps) only elicited the mean, and calculated the mean and precision using mean values across experts (did not elicit lowest, highest and confidence). 

Use BBN figure (Example BBN for elicitation of variables, see Ban et al. 2015) to identify important conditional probabilities (i.e., riparian x upland, local x upstream) effects?

Method: email survey, web-survey (talk to Jeff/Ben), telephone interview, face-to-face interview, group meeting?

Provide list of literature to help promote baserate-thinking (outside vs. inside/recent views). 

See Appendix A for survey.

#### Appendix A. Survey

*Description:*

*Background Information*
Average size catchment (or smaller; size range) anywhere across the range
Range of species 1:
Range of species 2:
Range of species 3:

Question 1. In your opinion, what is the overall mean probability of occupancy for each species across it's entire range?

A. Desmognathus fuscus (dusky salamander)            ________(0-1)

B. Gyrinophilus porphyriticus (spring salamander)    ________(0-1)

C. Eurycea bislineata (two-lined salamander)         ________(0-1)

Question 2. In your opinion, what is the expected probability of occupancy for a catchment that none, low, medium, moderate, high, and all forest cover?

A. 0% forest cover           ________(0-1)

B. Gyrinophilus porphyriticus (spring salamander)    ________(0-1)

C. Eurycea bislineata (two-lined salamander)         ________(0-1)


```{r expert.value.int,echo=FALSE,results='hide'}
value<-list()
value$int[1:no.simulations]<-runif(no.simulations,0.60,1.00)
```
Question 2. What is the expected probability of occupancy of X species in catchments with different drainage areas (i.e., stream size)?
```{r expert.value.drainage,echo=FALSE,results='hide'}
e.list["drainage_area_sqkm"]
value$drainage[1:no.simulations]<-runif(no.simulations,0.60,1.00)
```

#### List of Experts

Identify experts using the snowball method (ask preliminary list of experts: Who would you go to for expert judgments on salamander ecology for these three species? Why?) until no new experts are identified.

Criteria for selecting experts:

Number of publications involving salamanders
1. Include Desmognathus spp.
2. Include Gryinophilus spp.
3. Include Eurycea spp.

Area of expertises (0=none, 1=some, 2=moderate, 3=lots) for each expert
1. General salamander ecology
2. Landcover effects
3. Riparian effects
4. Stream temperature effects
6. Fish-predation effects
7. Streamflow (drought and floods) effects
8. Occupancy modeling 
9. Abundance modeling

```{r expert.list,echo=FALSE,results='hide'}
head(expert.list.data)
```


#### Forecasting Scenarios 

### Results
*Experts responses*
Descripton of how many experts responded.
Parameter estimates (betas) with low vs. high variance among experts.
Model beliefs (weights) with low vs. high variance among experts.
Comparisons across species (similar or different - how?)

Table of results (or plot for specific interesting cases).

Insights about elicitation (base-rates and use of literature we provided)

*Salamander forecasting*
Map of mean expected occupancy for each species with all uncertainties included under current climate, 2040, and 2080 (whichever scenarios we pick)

Histogram of mean expected occupancy for each species with all uncertainties included under current climate, 2040, and 2080 (whichever scenarios we pick). This will show range in expected values (i.e., how many catchments look really bad?)


*Sensitivity analysis*

### Discussion
### References




